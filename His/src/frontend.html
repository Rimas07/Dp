<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIS - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }

        .header p {
            text-align: center;
            color: #7f8c8d;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-btn:hover {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        .nav-btn.active {
            background: #e74c3c;
            color: white;
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #27ae60;
        }

        .status-offline {
            background: #e74c3c;
        }

        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
                align-items: center;
            }

            .nav-btn {
                width: 200px;
            }

            .container {
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üè• HIS - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π</h1>
            <p>–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏ —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏</p>
        </div>

        <nav class="nav">
            <button class="nav-btn" onclick="showSection('login')">üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</button>
            <button class="nav-btn" onclick="showSection('tenants')">üè¢ –ö–æ–º–ø–∞–Ω–∏–∏</button>
            <button class="nav-btn" onclick="showSection('patients')">üë• –ü–∞—Ü–∏–µ–Ω—Ç—ã</button>
            <button class="nav-btn" onclick="showSection('limits')">üìä –õ–∏–º–∏—Ç—ã</button>
            <button class="nav-btn" onclick="showSection('audit')">üìã –ê—É–¥–∏—Ç</button>
            <button class="nav-btn" onclick="logout()" style="background: #e74c3c;">üö™ –í—ã–π—Ç–∏</button>
        </nav>

        <div class="content">
            <!-- –°–µ–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
            <div id="login" class="section active">
                <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-success">–í–æ–π—Ç–∏</button>
                </form>
                <div id="loginMessage"></div>
                <button onclick="debugToken()" class="btn" style="margin-top: 10px;">üîç –û—Ç–ª–∞–¥–∫–∞ —Ç–æ–∫–µ–Ω–∞</button>
            </div>

            <!-- –°–µ–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ -->
            <div id="tenants" class="section">
                <h2>üè¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏—è–º–∏</h2>
                <form id="createCompanyForm">
                    <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–º–ø–∞–Ω–∏—é</h3>
                    <div class="form-group">
                        <label for="companyName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏:</label>
                        <input type="text" id="companyName" name="companyName" required>
                    </div>
                    <h4>–î–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</h4>
                    <div class="form-group">
                        <label for="adminName">–ò–º—è:</label>
                        <input type="text" id="adminName" name="adminName" required>
                    </div>
                    <div class="form-group">
                        <label for="adminEmail">Email:</label>
                        <input type="email" id="adminEmail" name="adminEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">–ü–∞—Ä–æ–ª—å:</label>
                        <input type="password" id="adminPassword" name="adminPassword" required>
                    </div>
                    <button type="submit" class="btn btn-success">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</button>
                </form>
                <div id="companyMessage"></div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ -->
            <div id="patients" class="section">
                <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞–º–∏</h2>
                <div class="form-group">
                    <label for="tenantId">ID –¢–µ–Ω–∞–Ω—Ç–∞:</label>
                    <input type="text" id="tenantId" name="tenantId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Ç–µ–Ω–∞–Ω—Ç–∞">
                </div>
                <button onclick="loadPatients()" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</button>
                <button onclick="showCreatePatientForm()" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</button>

                <div id="createPatientForm" class="hidden">
                    <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
                    <form id="patientForm">
                        <div class="form-group">
                            <label for="patientName">–ò–º—è:</label>
                            <input type="text" id="patientName" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="patientSurname">–§–∞–º–∏–ª–∏—è:</label>
                            <input type="text" id="patientSurname" name="surname" required>
                        </div>
                        <div class="form-group">
                            <label for="patientAge">–í–æ–∑—Ä–∞—Å—Ç:</label>
                            <input type="text" id="patientAge" name="age" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 25">
                        </div>
                        <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</button>
                        <button type="button" onclick="hideCreatePatientForm()" class="btn btn-danger">–û—Ç–º–µ–Ω–∞</button>
                    </form>
                </div>

                <div id="patientsList"></div>
                <div id="patientsMessage"></div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –ª–∏–º–∏—Ç–æ–≤ -->
            <div id="limits" class="section">
                <h2>üìä –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞–º–∏</h2>
                <div class="form-group">
                    <label for="limitsTenantId">ID –¢–µ–Ω–∞–Ω—Ç–∞:</label>
                    <input type="text" id="limitsTenantId" name="limitsTenantId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID —Ç–µ–Ω–∞–Ω—Ç–∞">
                </div>
                <button onclick="loadLimits()" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–∏–º–∏—Ç—ã</button>
                <button onclick="loadUsage()" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>

                <div id="limitsContent"></div>
                <div id="limitsMessage"></div>
            </div>

            <!-- –°–µ–∫—Ü–∏—è –∞—É–¥–∏—Ç–∞ -->
            <div id="audit" class="section">
                <h2>üìã –ñ—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞</h2>
                <p>–ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∂—É—Ä–Ω–∞–ª –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ.</p>
                <button onclick="loadSystemStats()" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                <button onclick="testPatientsCount()" class="btn">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</button>
                <div class="card">
                    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
                    <div class="grid">
                        <div class="card">
                            <h4>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–Ω–∞–Ω—Ç–æ–≤</h4>
                            <p id="totalTenants">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                        </div>
                        <div class="card">
                            <h4>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</h4>
                            <p id="totalPatients">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                        </div>
                        <div class="card">
                            <h4>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h4>
                            <p><span class="status-indicator status-online"></span>–û–Ω–ª–∞–π–Ω</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
        const API_BASE_URL = 'http://localhost:3000';
        let currentToken = localStorage.getItem('authToken');
        let currentTenantId = localStorage.getItem('currentTenantId');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function () {
            if (currentToken) {
                showMessage('loginMessage', '–í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã', 'success');
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º Tenant ID –µ—Å–ª–∏ –æ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω
                if (currentTenantId) {
                    document.getElementById('tenantId').value = currentTenantId;
                    document.getElementById('limitsTenantId').value = currentTenantId;
                }
            } else {
                showMessage('loginMessage', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–∏—Å—Ç–µ–º–æ–π', 'error');
            }
            loadSystemStats();
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function showSection(sectionId) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Å–µ–∫—Ü–∏–∏
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é
            document.getElementById(sectionId).classList.add('active');

            // –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –∫–Ω–æ–ø–∫–µ
            event.target.classList.add('active');
        }

        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
        function showMessage(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentToken = data.accessToken; // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: accessToken –≤–º–µ—Å—Ç–æ access_token
                    currentTenantId = data.tenantId; // –°–æ—Ö—Ä–∞–Ω—è–µ–º tenantId
                    localStorage.setItem('authToken', currentToken);
                    localStorage.setItem('currentTenantId', currentTenantId);
                    showMessage('loginMessage', `–£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è! Tenant ID: ${currentTenantId}`, 'success');
                    console.log('–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', currentToken);
                    console.log('Tenant ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', currentTenantId);
                } else {
                    showMessage('loginMessage', `–û—à–∏–±–∫–∞: ${data.message || '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'}`, 'error');
                }
            } catch (error) {
                showMessage('loginMessage', `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
        document.getElementById('createCompanyForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const companyData = {
                companyName: document.getElementById('companyName').value,
                user: {
                    name: document.getElementById('adminName').value,
                    email: document.getElementById('adminEmail').value,
                    password: document.getElementById('adminPassword').value
                }
            };

            try {
                const response = await fetch(`${API_BASE_URL}/tenants/create-company`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(companyData)
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('companyMessage', `–ö–æ–º–ø–∞–Ω–∏—è "${data.companyName}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! ID: ${data.tenantId}`, 'success');
                    document.getElementById('createCompanyForm').reset();
                } else {
                    showMessage('companyMessage', `–û—à–∏–±–∫–∞: ${data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é'}`, 'error');
                }
            } catch (error) {
                showMessage('companyMessage', `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞–º–∏
        function showCreatePatientForm() {
            document.getElementById('createPatientForm').classList.remove('hidden');
        }

        function hideCreatePatientForm() {
            document.getElementById('createPatientForm').classList.add('hidden');
            document.getElementById('patientForm').reset();
        }

        document.getElementById('patientForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const tenantId = document.getElementById('tenantId').value;
            if (!tenantId) {
                showMessage('patientsMessage', '–í–≤–µ–¥–∏—Ç–µ ID —Ç–µ–Ω–∞–Ω—Ç–∞', 'error');
                return;
            }

            if (!currentToken) {
                showMessage('patientsMessage', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è', 'error');
                return;
            }

            const patientData = {
                name: document.getElementById('patientName').value,
                surname: document.getElementById('patientSurname').value,
                age: document.getElementById('patientAge').value // –í–æ–∑—Ä–∞—Å—Ç –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ö–µ–º–µ
            };

            try {
                const response = await fetch(`${API_BASE_URL}/patients`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Tenant-ID': tenantId,
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(patientData)
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('patientsMessage', '–ü–∞—Ü–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                    document.getElementById('patientForm').reset();
                    hideCreatePatientForm();
                    loadPatients();
                } else {
                    showMessage('patientsMessage', `–û—à–∏–±–∫–∞: ${data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞'}`, 'error');
                }
            } catch (error) {
                showMessage('patientsMessage', `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        });

        async function loadPatients() {
            const tenantId = document.getElementById('tenantId').value;
            if (!tenantId) {
                showMessage('patientsMessage', '–í–≤–µ–¥–∏—Ç–µ ID —Ç–µ–Ω–∞–Ω—Ç–∞', 'error');
                return;
            }

            if (!currentToken) {
                showMessage('patientsMessage', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/patients`, {
                    headers: {
                        'X-Tenant-ID': tenantId,
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    displayPatients(data);
                } else {
                    showMessage('patientsMessage', `–û—à–∏–±–∫–∞: ${data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤'}`, 'error');
                }
            } catch (error) {
                showMessage('patientsMessage', `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        function displayPatients(patients) {
            const container = document.getElementById('patientsList');

            if (!patients || patients.length === 0) {
                container.innerHTML = '<p>–ü–∞—Ü–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            let html = '<table class="table"><thead><tr><th>–ò–º—è</th><th>–§–∞–º–∏–ª–∏—è</th><th>–í–æ–∑—Ä–∞—Å—Ç</th></tr></thead><tbody>';

            patients.forEach(patient => {
                html += `
                    <tr>
                        <td>${patient.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                        <td>${patient.surname || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                        <td>${patient.age || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞–º–∏
        async function loadLimits() {
            const tenantId = document.getElementById('limitsTenantId').value;
            if (!tenantId) {
                showMessage('limitsMessage', '–í–≤–µ–¥–∏—Ç–µ ID —Ç–µ–Ω–∞–Ω—Ç–∞', 'error');
                return;
            }

            if (!currentToken) {
                showMessage('limitsMessage', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/limits/${tenantId}`, {
                    headers: {
                        'X-Tenant-ID': tenantId,
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (response.ok) {
                    displayLimits(data);
                } else {
                    showMessage('limitsMessage', `–û—à–∏–±–∫–∞: ${data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∏–º–∏—Ç—ã'}`, 'error');
                }
            } catch (error) {
                showMessage('limitsMessage', `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        async function loadUsage() {
            const tenantId = document.getElementById('limitsTenantId').value;
            if (!tenantId) {
                showMessage('limitsMessage', '–í–≤–µ–¥–∏—Ç–µ ID —Ç–µ–Ω–∞–Ω—Ç–∞', 'error');
                return;
            }

            if (!currentToken) {
                showMessage('limitsMessage', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/limits/usage/${tenantId}`, {
                    headers: {
                        'X-Tenant-ID': tenantId,
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (response.ok) {
                    displayUsage(data);
                } else {
                    showMessage('limitsMessage', `–û—à–∏–±–∫–∞: ${data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É'}`, 'error');
                }
            } catch (error) {
                showMessage('limitsMessage', `–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            }
        }

        function displayLimits(limits) {
            const container = document.getElementById('limitsContent');
            container.innerHTML = `
                <h3>–¢–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã</h3>
                <div class="card">
                    <pre>${JSON.stringify(limits, null, 2)}</pre>
                </div>
            `;
        }

        function displayUsage(usage) {
            const container = document.getElementById('limitsContent');
            container.innerHTML = `
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h3>
                <div class="card">
                    <pre>${JSON.stringify(usage, null, 2)}</pre>
                </div>
            `;
        }

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
        async function loadSystemStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/audit/stats`);
                const data = await response.json();

                console.log('üìä –ü–æ–ª—É—á–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', data);

                if (response.ok) {
                    document.getElementById('totalTenants').textContent = data.totalTenants || 0;
                    document.getElementById('totalPatients').textContent = data.totalPatients || 0;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
                    const statusElement = document.querySelector('.status-indicator');
                    if (data.systemStatus === 'online') {
                        statusElement.className = 'status-indicator status-online';
                        statusElement.nextSibling.textContent = '–û–Ω–ª–∞–π–Ω';
                    } else {
                        statusElement.className = 'status-indicator status-offline';
                        statusElement.nextSibling.textContent = '–û—à–∏–±–∫–∞';
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∞—É–¥–∏—Ç–∞
                    displayRecentEvents(data.recentEvents || []);
                } else {
                    document.getElementById('totalTenants').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                    document.getElementById('totalPatients').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                document.getElementById('totalTenants').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                document.getElementById('totalPatients').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏—Ç–∞
        function displayRecentEvents(events) {
            const auditSection = document.getElementById('audit');
            let eventsHtml = '';

            if (events && events.length > 0) {
                eventsHtml = `
                    <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
                    <div class="card">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>–í—Ä–µ–º—è</th>
                                    <th>–°–æ–±—ã—Ç–∏–µ</th>
                                    <th>–¢–µ–Ω–∞–Ω—Ç</th>
                                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                events.forEach(event => {
                    const date = new Date(event.timestamp).toLocaleString('ru-RU');
                    eventsHtml += `
                        <tr>
                            <td>${date}</td>
                            <td>${event.eventType || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                            <td>${event.tenantId || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                            <td>${event.userId || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                        </tr>
                    `;
                });

                eventsHtml += '</tbody></table></div>';
            } else {
                eventsHtml = '<p>–°–æ–±—ã—Ç–∏—è –∞—É–¥–∏—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏—è –≤ —Å–µ–∫—Ü–∏—é –∞—É–¥–∏—Ç–∞
            const existingEvents = auditSection.querySelector('.audit-events');
            if (existingEvents) {
                existingEvents.remove();
            }

            const eventsDiv = document.createElement('div');
            eventsDiv.className = 'audit-events';
            eventsDiv.innerHTML = eventsHtml;
            auditSection.appendChild(eventsDiv);
        }

        // –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞
        function logout() {
            currentToken = null;
            currentTenantId = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentTenantId');

            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            document.getElementById('tenantId').value = '';
            document.getElementById('limitsTenantId').value = '';

            showMessage('loginMessage', '–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'success');
            showSection('login');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Ç–æ–∫–µ–Ω–∞
        function debugToken() {
            console.log('–¢–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω:', currentToken);
            console.log('–¢–µ–∫—É—â–∏–π Tenant ID:', currentTenantId);

            if (currentToken) {
                try {
                    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω (–±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏)
                    const payload = JSON.parse(atob(currentToken.split('.')[1]));
                    console.log('Payload —Ç–æ–∫–µ–Ω–∞:', payload);
                    console.log('–í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è:', new Date(payload.exp * 1000));
                } catch (e) {
                    console.log('–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', e);
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥—Å—á–µ—Ç–∞ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
        async function testPatientsCount() {
            try {
                console.log('üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥—Å—á–µ—Ç –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤...');
                const response = await fetch(`${API_BASE_URL}/audit/patients-count`);
                const data = await response.json();

                console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–¥—Å—á–µ—Ç–∞ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤:', data);

                if (response.ok) {
                    alert(`–ù–∞–π–¥–µ–Ω–æ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤: ${data.totalPatients}\n–¢–µ–Ω–∞–Ω—Ç–æ–≤: ${data.totalTenants}\n\n–î–µ—Ç–∞–ª–∏:\n${JSON.stringify(data.tenantStats, null, 2)}`);
                } else {
                    alert(`–û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                alert(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ CORS
        window.addEventListener('error', function (e) {
            if (e.message.includes('CORS')) {
                console.warn('CORS –æ—à–∏–±–∫–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ backend —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è CORS.');
            }
        });
    </script>
</body>

</html>

</html>

</html>

</html>

</html>

</html>

</html>