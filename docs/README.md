HIS — Документация проекта

Часть 1. Простое объяснение для пользователей (без технических деталей)

Что это за система
- Это система для работы с пациентами и компаниями (арендаторами).
- Она хранит данные пациентов, следит за ограничениями по использованию (лимитами) и ведёт журнал действий (аудит).

Что вы можете делать
- Просматривать список пациентов и добавлять новых.
- Настраивать лимиты использования для вашей компании: количество документов, объём данных и количество запросов в месяц.
- Получать предупреждения при приближении к лимиту и сообщения об ошибке при его превышении.
- Смотреть историю действий (аудит), чт��бы понять кто и когда что сделал.

Как это работает шаг за шагом
1) Создаётся компания (арендатор) — у неё появляется свой идентификатор tenantId.
2) Для компании настраиваются лимиты (максимум документов, объём данных, количество запросов).
3) Пользователь входит в систему (получает токен). После входа он может выполнять действия — смотреть пациентов или добавлять их.
4) Система автоматически проверяет лимиты. Если вы приближаетесь к лимиту, будет предупреждение. Если превышаете — действие блокируется и показывается ошибка.
5) Все важные действия записываются в журнал (аудит), чтобы можно было посмотреть историю.

Зачем нужны лимиты
- Чтобы система оставалась быстрой и стабильной.
- Чтобы каждая компания использовала ресурсы честно и в рамках своего тарифного плана.

Про безопасность и приватность
- Личные данные хранятся и передаются аккуратно.
- Секретные поля в журнале скрываются, чтобы не хранить лишние секреты.

Типичные вопросы
- Почему я не могу добавить пациента? Скорее всего, исчерпан лимит документов. Обратитесь к администратору, чтобы увеличить лимит.
- Почему список пациентов не открывается? Возможно, превышен месячный лимит запросов. Подождите до следующего периода или увеличьте лимит.
- Кто видит журнал действий? Доступ есть только у ответственных сотрудников или администраторов.

К кому обращаться при проблемах
- К администратору вашей компании.
- К технической поддержке проекта (укажите контакт согласно вашему процессу).


Часть 2. Документация для разработчиков

Обзор архитектуры
- Стек: Node.js, NestJS, MongoDB, RabbitMQ (для аудита), Mongoose.
- Монорепозиторий: несколько приложений/сервисов. Основной REST API — каталог His/.
- Важные модули (His/src):
  - patients — пациенты (контроллер, сервис, схема).
  - limits — лимиты и учёт использования (документы, объём данных, запросы). Проверки и события аудита.
  - audit — сбор и сохранение событий в БД, публикация в брокер.
  - tenants — арендаторы (создание компании, хранение tenantId).
  - auth, users — аутентификация и пользователи.
  - providers/services — подключения к БД арендаторов (multi-tenant через отдельные БД tenant_{id}).
  - proxy, guards, middlewares — инфраструктура.

Основные данные и потоки
- MongoDB: хранение доменных данных (пациенты, лимиты, использование, аудит).
- Multi-tenant: данные каждого арендатора изолируются в базе tenant_{tenantId}.
- Audit: каждое значимое действие фиксируется в коллекции аудита и публикуется в брокер (ClientProxy.emit) для централизованного анализа.
- Limits: при чтении и записи выполняются проверки; генерируются события LIMIT_WARNING, LIMIT_EXCEEDED, LIMIT_UPDATED и доменные (например, PATIENT_READ).

Требования к окружению
- Node.js 18+ (рекомендуется LTS) и npm.
- Доступная MongoDB (локально/облако).
- RabbitMQ — опционально, если нужен асинхронный сбор логов аудита.

Переменные окружения (пример)
- MONGODB_URI — строка подключения к MongoDB.
- RABBITMQ_URL — адрес RabbitMQ.
- PORT — порт HTTP-сервера.
- JWT_SECRET и другие секреты — если используется централизованный секрет (в проекте секреты лежат у арендатора и шифруются).

Запуск локально
- Установите зависимости в каталоге His: npm install
- Запуск разработки: npm run start:dev
- Продакшен: npm run build, затем npm run start:prod
- Убедитесь, что MongoDB доступна по MONGODB_URI. При использовании RabbitMQ — проверьте доступность брокера.

Аутентификация и заголовки
- Для защищённых маршрутов требуется:
  - Заголовок X-TENANT-ID: идентификатор арендатора.
  - Заголовок Authorization: Bearer <JWT> — токен, полученный через /auth/login.
- TenantsMiddleware проверяет X-TENANT-ID и существование арендатора
- TenantAuthenticationGuard валидирует JWT токен по аренда-специфичному секрету.

Эндпоинты (по контроллерам)
- Auth (His/src/auth/auth.controller.ts):
  - POST /auth/login — логин по email/паролю. Ответ: { accessToken, tenantId }.
- Tenants (His/src/tenants/tenants.controller.ts):
  - POST /tenants/create-company — создать компанию и пользователя, выпустить секрет для JWT.
- Patients (His/src/patients/patients.controller.ts) [защищено]:
  - GET /patients — список пациентов текущего арендатора (учёт лимита запросов, событие PATIENT_READ).
  - POST /patients — создание пациента (проверка лимитов документов и объёма данных, обновление usage).
- Limits (His/src/limits/limits.controller.ts) [защищено]:
  - GET /limits/:tenantId — получить лимиты арендатора (создаются дефолтные при отсутствии).
  - PUT /limits/:tenantId — обновить лимиты (генерирует событие LIMIT_UPDATED).
  - GET /limits/usage/:tenantId — получить текущее использование.
- Audit (His/src/audit/audit.controller.ts):
  - GET /audit?tenantId=&eventType=&limit= — получить события аудита с фильтрами.
- Proxy (His/src/proxy/proxy.controller.ts):
  - GET /proxy/health — health-check (status: ok).

Примеры запросов
- Логин:
  curl -X POST http://localhost:3000/auth/login \
    -H "Content-Type: application/json" \
    -d '{"email":"user@example.com","password":"pass"}'

- Запрос защищённого ресурса (список пациентов):
  curl http://localhost:3000/patients \
    -H "X-TENANT-ID: <tenantId>" \
    -H "Authorization: Bearer <accessToken>"

События и аудит
- AuditInterceptor логирует успешные и ошибочные HTTP-запросы.
- AuditService сохраняет событие в MongoDB и публикует его в брокер.
- DTO AuditEvent включает общие поля и тип события (eventType). При добавлении доменных событий обновляйте и DTO, и enum в схеме.

Лимиты и учёт использования (Usage)
- DataUsage хранит документы, объём данных (KB) и количество запросов.
- LimitsService.updateUsage инкрементирует usage после операций записи.
- Проверки генерируют события:
  - LIMIT_WARNING — при достижении ~90% лимита.
  - LIMIT_EXCEEDED — при превышении лимита (ForbiddenException с деталями).
  - LIMIT_UPDATED — при изменении лимитов.

Структура каталогов (кратко)
- His/src/audit — AuditInterceptor, AuditService, схемы/DTO.
- His/src/limits — сервис лимитов, схемы (limits/usage), контроллер.
- His/src/patients — контроллер, сервис, схема пациента.
- His/src/tenants — контроллер, сервис, схема арендатора.
- His/src/providers — провайдеры multi-tenant подключения.
- His/src/auth, users — аутентификация и пользователи.
- His/src/proxy — health-check.

Тестирование
- Типичные скрипты: npm run test, npm run test:e2e (см. package.json соответствующего пакета).

Развёртывание
- Убедитесь, что заданы переменные окружения.
- Сборка: npm run build
- Запуск: npm run start:prod
- MongoDB и (при необходимости) RabbitMQ должны быть доступны из окружения выполнения.

Расширение функциональности
- Новые события аудита — расширяйте eventType в DTO и enum в схеме audit.
- Новые лимиты — добавляйте поля в модель лимитов и проверки в LimitsService.
- Новые модули — придерживайтесь структуры NestJS: module, controller, service, schema/dto.

Точки внимания
- Согласованность типов между DTO (TypeScript) и Mongoose-схемами.
- Multi-tenant: корректное использование tenantId для подключен��я к базе tenant_{id}.
- Безопасность: не логируйте чувствительные данные в audit; используйте санитайзинг.

Диагностика проблем
- Превышение лимита: ForbiddenException с деталями (current, limit, attempted, percentage).
- Проблемы с MongoDB: проверьте MONGODB_URI и права.
- Нет событий аудита в брокере: проверьте RABBITMQ_URL и настройки ClientProxy.

Версионность и изменения
- Поддерживайте CHANGELOG при значимых изменениях (новые события, поля usage/limits, API).

Дополнительно о репозитории
- В корне есть producer и consumer — демонстрационные/сервисные проекты для обмена сообщениями. Они независимы от His и могут использоваться как примеры.

Конец документа.